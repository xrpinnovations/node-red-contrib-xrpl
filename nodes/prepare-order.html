<script type="text/x-red" data-template-name="prepare-order">
  <div class="form-row" title="Custom name to apply to this node">
    <label for="node-input-name"><i class="fa fa-tag"></i> Node Name</label>
    <input type="text" id="node-input-name" placeholder="Node Name">
  </div>

  <div class="form-row">
    <h3>Transaction</h3>
  </div>
  <div class="form-row" title="Which rippled server to connect to? Leaving blank defaults to offline mode">
    <label for="node-input-server"><i class="fa fa-dot-circle-o"></i> Server</label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row" title="The address of the account that is creating the transaction.">
    <label for="node-input-address"><i class="fa fa-tag"></i> Address</label>
    <input type="text" id="node-input-address" placeholder="XRP Address">
  </div>

  <div class='form-row' title='Equal to buy for buy orders and sell for sell orders. '>
      <label for='direction' ><i class='fa fa-tag'></i> Direction</label>
      <select id="direction">
          <option value='buy'>Buy</option>
          <option value='sell'>Sell</option>
      </select>
  </div> 
  
  <div class="form-row" id="add-quantity-container">
      <h4>Quantity:</h4>
      <div>
          <div class='form-row' title='The three-character code or hexadecimal string used to denote currencies, or drops for the smallest unit of XRP.'>
              <label for='quantity-currency'><i class='fa fa-tag'></i> Currency</label>
              <input type='text' id='quantity-currency' value='XRP'>
          </div>
          <div class='form-row' title='Optional The XRP address of the account that owes or is owed the funds (omitted if currency is XRP or drops)'>
              <label for='quantity-counterparty'><i class='fa fa-tag'></i> Counterparty</label>
              <input type='text' id='quantity-counterparty' placeholder=''>
          </div>
          <div class='form-row' title='Optional The quantity of the currency, denoted as a string to retain floating point precision'>
              <label for='quantity-value'><i class='fa fa-tag'></i> Value</label>
              <input type='text' id='quantity-value' placeholder=''>
          </div>
      </div>
  </div>

  <div class="form-row" id="add-total-price-container">
      <h4>Total Price:</h4>
      <div>
          <div class='form-row' title='The three-character code or hexadecimal string used to denote currencies, or drops for the smallest unit of XRP.'>
              <label for='total-price-currency'><i class='fa fa-tag'></i> Currency</label>
              <input type='text' id='total-price-currency' value='XRP'>
          </div>
          <div class='form-row' title='Optional The XRP address of the account that owes or is owed the funds (omitted if currency is XRP or drops)'>
              <label for='total-price-counterparty'><i class='fa fa-tag'></i> Counterparty</label>
              <input type='text' id='total-price-counterparty' placeholder=''>
          </div>
          <div class='form-row' title='Optional The quantity of the currency, denoted as a string to retain floating point precision'>
              <label for='total-price-value'><i class='fa fa-tag'></i> Value</label>
              <input type='text' id='total-price-value' placeholder=''>
          </div>
      </div>
  </div>
  
  <div class="form-row" id="add-expirationTime-container"  title="Optional Time after which the offer is no longer active, as an ISO 8601 date-time ">
      <h4>Expiration Time</h4>
      <div>
        <div class="form-row" style="text-align: right;">
          <label style="width: 30%;text-align: left;">Day</label>
          <label style="width: 30%;text-align: left;">Month</label>
          <label style="text-align: left;">Year</label>
        </div>

        <div class="form-row" style="text-align: right;">
          <div style="width: 30%; display: inline-block;">
            <input type="text" id="expirationTime-day" style="width: 100%;" placeholder="0">
          </div>
          <div style="width: 30%; display: inline-block;">
            <input type="text" id="expirationTime-month" style="width: 100%;" placeholder="0">
          </div>
          <div style="width: 30%; display: inline-block;">
            <input type="text" id="expirationTime-year" style="width: 100%;" placeholder="0000">
          </div>
        </div>

        <div class="form-row" style="text-align: right;">
          <label style="width: 30%;text-align: left;">Hours (24hr)</label>
          <label style="width: 30%;text-align: left;">Minutes</label>
        </div>

        <div class="form-row" style="text-align: right;">
          <div style="width: 30%; display: inline-block;">
            <input type="text" id="expirationTime-hours" style="width: 100%;" value="00">
          </div>
          <div style="width: 30%; display: inline-block;">
            <input type="text" id="expirationTime-minutes" style="width: 100%;" value="00">
          </div>
        </div>

        <div class="form-row" style="text-align: right;">
          <label for="expirationTime-date" style="text-align: left;"><i class="fa fa-tag"></i> Date</label>
          <input type="text" id="expirationTime" value="0000-00-00T00:00:00.000Z">
        </div>

      </div>
    </div>

  <div class='form-row' title='Optional Treat the offer as a Fill or Kill order . Only attempt to match existing offers in the ledger, and only do so if the entire quantity can be exchanged. This cannot be used with immediateOrCancel. '>
      <label for='fillOrKill' ><i class='fa fa-tag'></i> Fill Or Kill</label>
      <select id="fillOrKill">
        <option value=''>Unset</option>
        <option value='true'>True</option>
        <option value='false'>False</option>
      </select>
  </div>
  <div class='form-row' title='Optional Treat the offer as an Immediate or Cancel order . If enabled, the offer will never become a ledger node: it only attempts to match existing offers in the ledger. This cannot be used with fillOrKill. '>
      <label for='immediateOrCancel' ><i class='fa fa-tag'></i> Immediate Or Cancel</label>
      <select id="immediateOrCancel">
        <option value=''>Unset</option>
        <option value='true'>True</option>
        <option value='false'>False</option>
      </select>
  </div>
  <div class='form-row' title='Optional The account sequence number of an order to cancel before the new order is created, effectively replacing the old order. '>
      <label for='orderToReplace' ><i class='fa fa-tag'></i> Order To Replace</label>
      <input type='text' id='orderToReplace' placeholder=''>
  </div>
  <div class='form-row' title='Optional If enabled, the offer will not consume offers that exactly match it, and instead becomes an Offer node in the ledger. It will still consume offers that cross it. '>
      <label for='passive' ><i class='fa fa-tag'></i> Passive</label>
      <select id="passive">
        <option value=''>Unset</option>
        <option value='true'>True</option>
        <option value='false'>False</option>
      </select>
  </div>


  <!-- -------------------------------------------------------------- -->
  <!-- Add Memos                                                      -->
  <!-- -------------------------------------------------------------- -->
  <div class="form-row" id="add-memo-container">
      <h4>Add A Memo Field</h4>
      <div>
        <!-- Format Value -->
        <div class="form-row" title="Optional Conventionally containing information on how the memo is encoded, for example as a MIME type . Only characters allowed in URLs are permitted.">
          <label for="memo-format-value"><i class="fa fa-tag"></i> Format</label>
          <input type="text" id="memo-format-value"/>
        </div>

        <!-- Type Value -->
        <div class="form-row">
          <label for="memo-type-value" title="Optional Conventionally, a unique relation (according to RFC 5988 ) that defines the format of this memo. Only characters allowed in URLs are permitted."><i class="fa fa-tag"></i> Type</label>
          <input type="text" id="memo-type-value"/>
        </div>

        <!-- Data Value -->
        <div class="form-row" title="Optional Arbitrary string, conventionally containing the content of the memo.">
          <label for="memo-data-value"><i class="fa fa-tag"></i> Data</label>
          <input type="text" id="memo-data-value"/>
        </div>

        <!-- Add Memo Button -->
        <div class="form-row">
          <button id="memo-add-btn" style="width: 100%">Add Memo</button>
        </div>

        <!-- Memo List -->
        <div class="form-row">
            <ol id="memo-list"></ol>
        </div>
      </div>
    </div>
  </div>

  <!-- -------------------------------------------------------------- -->
  <!-- Add Instructions                                               -->
  <!-- -------------------------------------------------------------- -->
  <div class="form-row" id="add-instruction-container">
    <h4>Add An Instruction</h4>
    <div>
      <!-- Fee Value -->
      <div class="form-row" title="Optional An exact fee to pay for the transaction. See Transaction Fees for more information.">
        <label for="instructions-fee"><i class="fa fa-tag"></i> Fee (Drops)</label>
        <input type="text" id="instructions-fee"/>
      </div>

      <!-- Max Ledger Version Value -->
      <div class="form-row" title="Optional The highest ledger version that the transaction can be included in. If this option and maxLedgerVersionOffset are both omitted, the maxLedgerVersion option will default to 3 greater than the current validated ledger version (equivalent to maxLedgerVersionOffset=3). Use null to not set a maximum ledger version.">
        <label for="instructions-maxLedgerVersion"><i class="fa fa-tag"></i> Max Ledger Version</label>
        <input type="text" id="instructions-maxLedgerVersion" />
      </div>

      <!-- Max Ledger Version Offset Value -->
      <div class="form-row" title="Optional Offset from current validated ledger version to highest ledger version that the transaction can be included in.">
        <label for="instructions-maxLedgerVersionOffset"><i class="fa fa-tag"></i> Max Ledger Version Offset</label>
        <input type="text" id="instructions-maxLedgerVersionOffset"/>
      </div>

      <!-- Sequence Value -->
      <div class="form-row" title="Optional The initiating account's sequence number for this transaction.">
        <label for="instructions-sequence"><i class="fa fa-tag"></i> Sequence</label>
        <input type="text" id="instructions-sequence"/>
      </div>

      <!-- Signers Count Value -->
      <div class="form-row" title="Optional Number of signers that will be signing this transaction.">
        <label for="instructions-signersCount"><i class="fa fa-tag"></i> Signers Count</label>
        <input type="text" id="instructions-signersCount"/>
      </div>
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="prepare-order">
  <p>Prepare an order transaction. The prepared transaction must subsequently be signed and submitted.</p>
  <h3>Inputs</h3>
  <p>
      Set via <b>msg.payload</b>, or set within the node interface.
  </p>
  <dl class="message-properties">
      <dt class="optional">Name
          <span class="property-type">String</span>
      </dt>
      <dd> Custom name to apply to this node</dd>

      <dt class="optional">Server
          <span class="property-type">Node</span>
      </dt>
      <dd> Which rippled server to connect to? Leaving blank defaults to offline mode</dd>

      <dt>Address / payload.address
          <span class="property-type">String</span>
      </dt>
      <dd> The address of the account that is creating the transaction</dd>

      <dt>payload.order.direction<span class='property-type'>string</span>
      </dt>
      <dd> Equal to buy for buy orders and sell for sell orders.</dd>
      <dt>payload.order.quantity<span class='property-type'>amount</span>
      </dt>
      <dd> The amount of currency to buy or sell.</dd>
      <dt>payload.order.totalPrice<span class='property-type'>amount</span>
      </dt>
      <dd> The total price to be paid for the quantity to be bought or sold.</dd>
      <dt class='optional'>payload.order.expirationTime<span class='property-type'>date-time string</span>
      </dt>
      <dd> Optional Time after which the offer is no longer active, as an ISO 8601 date-time .</dd>
      <dt class='optional'>payload.order.fillOrKill<span class='property-type'>boolean</span>
      </dt>
      <dd> Optional Treat the offer as a Fill or Kill order . Only attempt to match existing offers in the ledger, and only do so if the entire quantity can be exchanged. This cannot be used with immediateOrCancel.</dd>
      <dt class='optional'>payload.order.immediateOrCancel<span class='property-type'>boolean</span>
      </dt>
      <dd> Optional Treat the offer as an Immediate or Cancel order . If enabled, the offer will never become a ledger node: it only attempts to match existing offers in the ledger. This cannot be used with fillOrKill.</dd>
      <dt class='optional'>payload.order.orderToReplace<span class='property-type'>sequence</span>
      </dt>
      <dd> Optional The account sequence number of an order to cancel before the new order is created, effectively replacing the old order.</dd>
      <dt class='optional'>payload.order.passive<span class='property-type'>boolean</span>
      </dt>
      <dd> Optional If enabled, the offer will not consume offers that exactly match it, and instead becomes an Offer node in the ledger. It will still consume offers that cross it.</dd>

      <dt class="optional">payload.order.memos
          <span class="property-type">JSON Array</span>
      </dt>
      <dd> Optional Array of memos to attach to the transaction.</dd>

      <dt class="optional">Memos Data / payload.order.memos.[{data}]
          <span class="property-type">String</span>
      </dt>
      <dd> Optional Arbitrary string, conventionally containing the content of the memo.</dd>

      <dt class="optional">Memos Format / payload.order.memos.[{format}]
          <span class="property-type">String</span>
      </dt>
      <dd> Optional Conventionally containing information on how the memo is encoded, for example as a MIME type . Only characters allowed in URLs are permitted.</dd>

      <dt class="optional">Memos Type / payload.order.memos.[{type}]
          <span class="property-type">String</span>
      </dt>
      <dd> Optional Conventionally, a unique relation (according to RFC 5988 ) that defines the format of this memo. Only characters allowed in URLs are permitted.</dd>

      <dt class="optional">payload.instructions
          <span class="property-type">JSON</span>
      </dt>
      <dd> The instructions to be set. Defaults are used if not set.<br><code>Note</code> If used in offline mode you must specify the fee, sequence, and maxLedgerVersion parameters in the transaction instructions.</dd>

      <dt class="optional">Fee / payload.instructions.fee
          <span class="property-type">Float</span>
      </dt>
      <dd> Optional An exact fee to pay for the transaction. See Transaction Fees for more information.</dd>

      <dt class="optional">Max Ledger Version / payload.instructions.maxLedgerVersion
          <span class="property-type">Integer</span>
      </dt>
      <dd> Optional The highest ledger version that the transaction can be included in. If this option and maxLedgerVersionOffset are both omitted, the maxLedgerVersion option will default to 3 greater than the current validated ledger version (equivalent to maxLedgerVersionOffset=3). Use null to not set a maximum ledger version.</dd>

      <dt class="optional">Max Ledger Version Offset / payload.instructions.maxLedgerVersionOffset
          <span class="property-type">Integer</span>
      </dt>
      <dd> Optional Offset from current validated ledger version to highest ledger version that the transaction can be included in.</dd>

      <dt class="optional">Sequence / payload.instructions.sequence
          <span class="property-type">Integer</span>
      </dt>
      <dd> Optional The initiating account's sequence number for this transaction.</dd>

      <dt class="optional">Signers Count / payload.instructions.signersCount
          <span class="property-type">Integer</span>
      </dt>
      <dd> Optional Number of signers that will be signing this transaction.</dd>
  </dl>

 <h3>Output</h3>
  <dl class="message-properties">
      <dt>payload
          <span class="property-type">Object</span>
      </dt>
      <dd> Contains further objects if successfull.</dd>

      <dt>payload.txJSON
          <span class="property-type">Object</span>
      </dt>
      <dd> Contains the prepared transaction</dd>

      <dt>payload.instructions
          <span class="property-type">Object</span>
      </dt>
      <dd> The instructions for how to execute the transaction after adding automatic defaults.</dd>

      <dt>error
          <span class="property-type">String</span>
      </dt>
      <dd> Contains any error messages.</dd>
  </dl>
  <h3>Reference</h3>
  <ul>
    <li><a href='https://xrpl.org/rippleapi-reference.html#prepareorder'>See XRPL Docs</a></li>
  </ul>
</script>

<!-- Finally, the node type is registered along with all of its properties   -->
<script type="text/javascript">
  RED.nodes.registerType('prepare-order',{
    category: 'XRPL Advanced',      // the palette category
    color: "#e2d96e",
    defaults: {             // defines the editable properties of the node
        name: {value:""},
        address: {value:""},
        server: {value:"", type:"get-server", required: false},
        order: { value: {} },
        instructions: { value: {} }
    },
    inputs:1,               // set the number of inputs - only 0 or 1
    outputs:1,              // set the number of outputs - 0 to n
    // set the icon (held in icons dir below where you save the node)
    icon: "create.png",     // saved in  icons/myicon.png
    label: function() {     // sets the default label contents
        return this.name||"Prepare Order";
    },
    labelStyle: function() { // sets the class to apply to the label
        return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {
      let node = this;
      const $accordionQuantity = $("#add-quantity-container");
      const $accordionTotalPrice = $("#add-total-price-container");
      const $accordionMemo = $("#add-memo-container");
      const $accordionInstructions = $("#add-instruction-container");
      const $accordionExpirationTime = $("#add-expirationTime-container");

      $.widget( "ui.dayspinner", $.ui.spinner, {
        options: {max: 31, min: 1},
        _format: function( value ) {
          return value > 9 ? "" + value: "0" + value;
        }
      });
      $.widget( "ui.monthspinner", $.ui.spinner, {
        options: {max: 12, min: 1},
        _format: function( value ) {
          return value > 9 ? "" + value: "0" + value;
        }
      });
      $.widget( "ui.yearspinner", $.ui.spinner, {options: {min: new Date().getFullYear()}} );
      $.widget( "ui.hourspinner", $.ui.spinner, {
        options: {max: 23, min: 0},
        _format: function( value ) {
          return value > 9 ? "" + value: "0" + value;
        }
      });
      $.widget( "ui.minutespinner", $.ui.spinner, {
        options: {max: 59, min: 0},
        _format: function( value ) {
          return value > 9 ? "" + value: "0" + value;
        }
      });

      const $expirationTime = {
        day: $( "#expirationTime-day" ),
        month: $( "#expirationTime-month" ),
        year: $( "#expirationTime-year" ),
        hour: $( "#expirationTime-hours" ),
        minute: $( "#expirationTime-minutes" )
      };

      const updateExpirationTime = function (event){
        $( "#expirationTime" ).val($expirationTime.year.val() + "-" + $expirationTime.month.val() + "-"
        + $expirationTime.day.val() + "T" + $expirationTime.hour.val() + ":" + $expirationTime.minute.val() + ":00.000Z");
      };

      $expirationTime.day.dayspinner({change: updateExpirationTime});
      $expirationTime.month.monthspinner({change: updateExpirationTime});
      $expirationTime.year.yearspinner({change: updateExpirationTime});
      $expirationTime.hour.hourspinner({change: updateExpirationTime});
      $expirationTime.minute.minutespinner({change: updateExpirationTime});

      const $memos = {
        list: $("#memo-list"),
        addBtn: $("#memo-add-btn"),

        data: $("#memo-data-value"),
        format: $("#memo-format-value"),
        type: $("#memo-type-value")
      };
      
      // **************************
      // * Add Memos
      // **************************
      const memosHandler = {
        onAddMemoButton: function(e) {
          const memo = {
            //id: utils.getRandomId(),
            data: $memos.data.val(),
            format: $memos.format.val(),
            type: $memos.type.val()
          };

          $memos.list.editableList("addItem", memo);
          $memos.data.val("");
          $memos.format.val("");
          $memos.type.val("");
        },
        onEditableListAdd: function(row, index, value) {
          const $row = $(row);
          const {
            type,
            format,
            data
          } = value;

          const rowHtml = `
          <b>Format:</b>&nbsp;${format}<br>
          <b>Type:</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${type}<br>
          <b>Data:</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${data}`;
          $row.html(rowHtml);
        }
      };

      $memos.addBtn.on("click", memosHandler.onAddMemoButton);

      // Memos List
      $memos.list.editableList({
        addButton: false,
        height: 100,
        sortable: true,
        removable: true,
        addItem: memosHandler.onEditableListAdd
      });

      // **************************
      // * General Init
      // **************************
      $accordionMemo.accordion({
        active: true,
        collapsible: true,
        heightStyle: "content"
      });
      $accordionInstructions.accordion({
        active: true,
        collapsible: true,
        heightStyle: "content"
      });
      $accordionQuantity.accordion({
        active: true,
        collapsible: true,
        heightStyle: "content"
      });
      $accordionTotalPrice.accordion({
        active: true,
        collapsible: true,
        heightStyle: "content"
      });
      $accordionExpirationTime.accordion({
        active: true,
        collapsible: true,
        heightStyle: "content"
      });

      // Add previous memos to editable lists
      node.order.memos.forEach(c =>
        $memos.list.editableList("addItem", c)
      );

      $('#expirationTime-day').val(node.expirationTime.day);
      $('#expirationTime-month').val(node.expirationTime.month);
      $('#expirationTime-year').val(node.expirationTime.year);
      $('#expirationTime-hours').val(node.expirationTime.hours);
      $('#expirationTime-minutes').val(node.expirationTime.minutes);

      $('#expirationTime').val(node.order.expirationTime);

      $('#quantity-currency').val(node.order.quantity.currency);
      $('#quantity-counterparty').val(node.order.quantity.counterparty);
      $('#quantity-value').val(node.order.quantity.value);
      $('#total-price-currency').val(node.order.totalPrice.currency);
      $('#total-price-counterparty').val(node.order.totalPrice.counterparty);
      $('#total-price-value').val(node.order.totalPrice.value);

      $('#direction').val(node.order.direction);

      $('#fillOrKill').val(node.order.fillOrKill);
      $('#immediateOrCancel').val(node.order.immediateOrCancel);
      $('#orderToReplace').val(node.order.orderToReplace);
      $('#passive').val(node.order.passive);

      $("#instructions-fee").val(node.instructions.fee);
      $("#instructions-maxFee").val(node.instructions.maxFee);
      $("#instructions-maxLedgerVersion").val(node.instructions.maxLedgerVersion);
      $("#instructions-maxLedgerVersion").val(node.instructions.maxLedgerVersion);
      $("#instructions-maxLedgerVersionOffset").val(node.instructions.maxLedgerVersionOffset);
      $("#instructions-sequence").val(node.instructions.sequence);
      $("#instructions-signersCount").val(node.instructions.signersCount);

    },
    oneditsave: function() {
      const $memosList = $("#memo-list");

      // Compile Memos
      const nodeMemos = [];
      const listMemos = $memosList.editableList("items");
      listMemos.each(function(i) {
        nodeMemos.push($(this).data("data"));
      });
      this.order.memos = nodeMemos;

      this.expirationTime = {};
      this.expirationTime.day = $('#expirationTime-day').val();
      this.expirationTime.month = $('#expirationTime-month').val();
      this.expirationTime.year = $('#expirationTime-year').val();
      this.expirationTime.hours = $('#expirationTime-hours').val();
      this.expirationTime.minutes = $('#expirationTime-minutes').val();

      this.order.expirationTime = $('#expirationTime').val();

      this.order.quantity = {};
      this.order.quantity.currency = $('#quantity-currency').val();
      this.order.quantity.counterparty = $('#quantity-counterparty').val();
      this.order.quantity.value = $('#quantity-value').val();

      this.order.totalPrice = {};
      this.order.totalPrice.currency = $('#total-price-currency').val();
      this.order.totalPrice.counterparty = $('#total-price-counterparty').val();
      this.order.totalPrice.value = $('#total-price-value').val();


      this.order.direction = $('#direction').val();
      this.order.fillOrKill = $('#fillOrKill').val();
      this.order.immediateOrCancel = $('#immediateOrCancel').val();
      this.order.orderToReplace = $('#orderToReplace').val();
      this.order.passive = $('#passive').val();

      this.instructions.fee = $("#instructions-fee").val();
      this.instructions.maxFee = $("#instructions-maxFee").val();
      this.instructions.maxLedgerVersion = $("#instructions-maxLedgerVersion").val();
      this.instructions.maxLedgerVersion = $("#instructions-maxLedgerVersion").val();
      this.instructions.maxLedgerVersionOffset = $("#instructions-maxLedgerVersionOffset").val();
      this.instructions.sequence = $("#instructions-sequence").val();
      this.instructions.signersCount = $("#instructions-signersCount").val();
    }
  });
</script>
